openapi: 3.0.3
info:
  title: Backend API – Usuarios, Tienda, Analítica y Bitácora
  version: 1.0.0
  description: |
    API para gestión de usuarios, tienda, analítica y bitácora.
    Autenticación **Bearer** con tokens firmados (no JWT) emitidos por `/auth/login/`.
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: "http://localhost:8000/api/"
    description: Servidor local
  - url: "https://web-production-a6f44.up.railway.app/api/"
    description: Producción en Railway

tags:
  - name: Auth
    description: Inicio/cierre de sesión y perfil autenticado
  - name: Usuarios
    description: Gestión de usuarios, roles y permisos
  - name: Tienda
    description: Flujos de cobro, checkout y webhooks
  - name: Analítica
    description: Indicadores y reportes internos
  - name: Bitácora
    description: Auditoría de acciones del sistema (solo Administrador)

security:
  - bearerToken: []

paths:
# ===================== ANALITICA =====================
  /Analítica/:
    get:
      tags: [Analítica]
      summary: Listar reportes
      description: |
        Lista cronológica (desc) reportes del sistema.
        **Solo lectura**. Requiere autenticación y rol **Administrador**.
      operationId: Analítica_reportes_listar
      security:
        - bearerToken: []
      x-permissions:
        - Administrador
      parameters:
        - $ref: "#/components/parameters/Page"
        - $ref: "#/components/parameters/PageSize"
      responses:
        "200":
          description: OK (paginado)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PaginatedBitacora"
              examples:
                ejemplo:
                  value:
                    count: 2
                    next: null
                    previous: null
                    results:
                      - id: 322
                        usuario: 12
                        usuario_username: "admin"
                        accion: "CREO UN USUARIO"
                        ip_address: "181.114.20.15"
                        creado_en: "2025-11-05T23:14:17Z"
                      - id: 321
                        usuario: 12
                        usuario_username: "admin"
                        accion: "LOGIN"
                        ip_address: "181.114.20.15"
                        creado_en: "2025-11-05T23:10:02Z"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  # ===================== BITÁCORA =====================
  /bitacora/:
    get:
      tags: [Bitácora]
      summary: Listar entradas de bitácora (solo Administrador)
      description: |
        Lista cronológica (desc) de eventos registrados por el sistema.
        **Solo lectura**. Requiere autenticación y rol **Administrador**.
      operationId: bitacora_listar
      security:
        - bearerToken: []
      x-permissions:
        - Administrador
      parameters:
        - $ref: "#/components/parameters/Page"
        - $ref: "#/components/parameters/PageSize"
      responses:
        "200":
          description: OK (paginado)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PaginatedBitacora"
              examples:
                ejemplo:
                  value:
                    count: 2
                    next: null
                    previous: null
                    results:
                      - id: 322
                        usuario: 12
                        usuario_username: "admin"
                        accion: "CREO UN USUARIO"
                        ip_address: "181.114.20.15"
                        creado_en: "2025-11-05T23:14:17Z"
                      - id: 321
                        usuario: 12
                        usuario_username: "admin"
                        accion: "LOGIN"
                        ip_address: "181.114.20.15"
                        creado_en: "2025-11-05T23:10:02Z"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"

  /bitacora/{id}/:
    get:
      tags: [Bitácora]
      summary: Obtener detalle de una entrada (solo Administrador)
      operationId: bitacora_obtener
      security:
        - bearerToken: []
      x-permissions:
        - Administrador
      parameters:
        - $ref: "#/components/parameters/IdPath"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/BitacoraEntry"
              examples:
                ejemplo:
                  value:
                    id: 322
                    usuario: 12
                    usuario_username: "admin"
                    accion: "CREO UN USUARIO"
                    ip_address: "181.114.20.15"
                    creado_en: "2025-11-05T23:14:17Z"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          $ref: "#/components/responses/NotFound"

  # ===================== AUTH =====================
  /auth/login/:
    post:
      tags: [Auth]
      summary: Iniciar sesión
      operationId: auth_login
      security: [] # público
      requestBody:
        $ref: "#/components/requestBodies/LoginRequest"
      responses:
        "200":
          description: Token emitido
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TokenResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /auth/me/:
    get:
      tags: [Auth]
      summary: Perfil autenticado
      operationId: auth_me
      security:
        - bearerToken: []
      responses:
        "200":
          description: Usuario autenticado
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UsuarioPublico"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /auth/logout/:
    post:
      tags: [Auth]
      summary: Cerrar sesión
      operationId: auth_logout
      security:
        - bearerToken: []
      responses:
        "204":
          description: Cerró sesión correctamente
        "401":
          $ref: "#/components/responses/Unauthorized"

  # ===================== USUARIOS =====================
  /usuario/:
    get:
      tags: [Usuarios]
      summary: Listar usuarios
      operationId: usuarios_listar
      security:
        - bearerToken: []
      parameters:
        - $ref: "#/components/parameters/Page"
        - $ref: "#/components/parameters/PageSize"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/UsuarioPublico"
        "401":
          $ref: "#/components/responses/Unauthorized"
    post:
      tags: [Usuarios]
      summary: Crear usuario
      operationId: usuarios_crear
      security:
        - bearerToken: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UsuarioCreate"
      responses:
        "201":
          description: Creado
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UsuarioPublico"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /usuario/{id}/:
    get:
      tags: [Usuarios]
      summary: Obtener usuario
      operationId: usuarios_obtener
      security:
        - bearerToken: []
      parameters:
        - $ref: "#/components/parameters/IdPath"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UsuarioPublico"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
    put:
      tags: [Usuarios]
      summary: Reemplazar usuario
      operationId: usuarios_reemplazar
      security:
        - bearerToken: []
      parameters:
        - $ref: "#/components/parameters/IdPath"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UsuarioUpdate"
      responses:
        "200":
          description: Actualizado
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UsuarioPublico"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
    patch:
      tags: [Usuarios]
      summary: Actualizar usuario (parcial)
      operationId: usuarios_actualizar
      security:
        - bearerToken: []
      parameters:
        - $ref: "#/components/parameters/IdPath"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UsuarioUpdate"
      responses:
        "200":
          description: Actualizado
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UsuarioPublico"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
    delete:
      tags: [Usuarios]
      summary: Eliminar usuario
      operationId: usuarios_eliminar
      security:
        - bearerToken: []
      parameters:
        - $ref: "#/components/parameters/IdPath"
      responses:
        "204":
          description: Eliminado
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

  # ===================== ROL =====================
  /rol/:
    get:
      tags: [Usuarios]
      summary: Listar roles
      operationId: rol_listar
      security:
        - bearerToken: []
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/Rol" }
        "401":
          $ref: "#/components/responses/Unauthorized"
    post:
      tags: [Usuarios]
      summary: Crear rol
      operationId: rol_crear
      security:
        - bearerToken: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/RolCreate" }
      responses:
        "201":
          description: Creado
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Rol" }
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /rol/{id}/:
    get:
      tags: [Usuarios]
      summary: Obtener rol
      operationId: rol_obtener
      security:
        - bearerToken: []
      parameters:
        - $ref: "#/components/parameters/IdPath"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Rol" }
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
    put:
      tags: [Usuarios]
      summary: Reemplazar rol
      operationId: rol_reemplazar
      security:
        - bearerToken: []
      parameters:
        - $ref: "#/components/parameters/IdPath"
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/RolUpdate" }
      responses:
        "200":
          description: Actualizado
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Rol" }
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
    patch:
      tags: [Usuarios]
      summary: Actualizar rol (parcial)
      operationId: rol_actualizar
      security:
        - bearerToken: []
      parameters:
        - $ref: "#/components/parameters/IdPath"
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/RolUpdate" }
      responses:
        "200":
          description: Actualizado
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Rol" }
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
    delete:
      tags: [Usuarios]
      summary: Eliminar rol
      operationId: rol_eliminar
      security:
        - bearerToken: []
      parameters:
        - $ref: "#/components/parameters/IdPath"
      responses:
        "204":
          description: Eliminado
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

  # ===================== PERMISO =====================
  /permiso/:
    get:
      tags: [Usuarios]
      summary: Listar permisos
      operationId: permiso_listar
      security:
        - bearerToken: []
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/Permiso" }
        "401":
          $ref: "#/components/responses/Unauthorized"
    post:
      tags: [Usuarios]
      summary: Crear permiso
      operationId: permiso_crear
      security:
        - bearerToken: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/PermisoCreate" }
      responses:
        "201":
          description: Creado
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Permiso" }
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /permiso/{id}/:
    get:
      tags: [Usuarios]
      summary: Obtener permiso
      operationId: permiso_obtener
      security:
        - bearerToken: []
      parameters:
        - $ref: "#/components/parameters/IdPath"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Permiso" }
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
    put:
      tags: [Usuarios]
      summary: Reemplazar permiso
      operationId: permiso_reemplazar
      security:
        - bearerToken: []
      parameters:
        - $ref: "#/components/parameters/IdPath"
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/PermisoUpdate" }
      responses:
        "200":
          description: Actualizado
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Permiso" }
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
    patch:
      tags: [Usuarios]
      summary: Actualizar permiso (parcial)
      operationId: permiso_actualizar
      security:
        - bearerToken: []
      parameters:
        - $ref: "#/components/parameters/IdPath"
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/PermisoUpdate" }
      responses:
        "200":
          description: Actualizado
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Permiso" }
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
    delete:
      tags: [Usuarios]
      summary: Eliminar permiso
      operationId: permiso_eliminar
      security:
        - bearerToken: []
      parameters:
        - $ref: "#/components/parameters/IdPath"
      responses:
        "204":
          description: Eliminado
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"

  # ===================== ROL-PERMISO =====================
  /rolpermiso/:
    get:
      tags: [Usuarios]
      summary: Listar vínculos rol-permiso
      operationId: rolpermiso_listar
      security:
        - bearerToken: []
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/RolPermiso" }
        "401":
          $ref: "#/components/responses/Unauthorized"
    post:
      tags: [Usuarios]
      summary: Crear vínculo rol-permiso
      operationId: rolpermiso_crear
      security:
        - bearerToken: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/RolPermisoCreate" }
      responses:
        "201":
          description: Creado
          content:
            application/json:
              schema: { $ref: "#/components/schemas/RolPermiso" }
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"

  /rolpermiso/{id}/:
    get:
      tags: [Usuarios]
      summary: Obtener vínculo rol-permiso
      operationId: rolpermiso_obtener
      security:
        - bearerToken: []
      parameters:
        - $ref: "#/components/parameters/IdPath"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/RolPermiso" }
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
    put:
      tags: [Usuarios]
      summary: Reemplazar vínculo rol-permiso
      operationId: rolpermiso_reemplazar
      security:
        - bearerToken: []
      parameters:
        - $ref: "#/components/parameters/IdPath"
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/RolPermisoUpdate" }
      responses:
        "200":
          description: Actualizado
          content:
            application/json:
              schema: { $ref: "#/components/schemas/RolPermiso" }
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
    patch:
      tags: [Usuarios]
      summary: Actualizar vínculo (parcial)
      operationId: rolpermiso_actualizar
      security:
        - bearerToken: []
      parameters:
        - $ref: "#/components/parameters/IdPath"
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/RolPermisoUpdate" }
      responses:
        "200":
          description: Actualizado
          content:
            application/json:
              schema: { $ref: "#/components/schemas/RolPermiso" }
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
    delete:
      tags: [Usuarios]
      summary: Eliminar vínculo
      operationId: rolpermiso_eliminar
      security:
        - bearerToken: []
      parameters:
        - $ref: "#/components/parameters/IdPath"
      responses:
        "204":
          description: Eliminado
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
          # ===== PARTE 2: TODOS los paths de TIENDA (van DENTRO de `paths:` con esta sangría) =====
  /categorias/:
    get:
      tags: [Tienda]
      summary: Listar categorías
      operationId: categorias_listar
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/Categoria" }
    post:
      tags: [Tienda]
      summary: Crear categoría
      operationId: categorias_crear
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/CategoriaCreate" }
      responses:
        "201":
          description: Creado
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Categoria" }

  "/categorias/{id}/":
    get:
      tags: [Tienda]
      summary: Obtener categoría
      operationId: categorias_obtener
      parameters:
        - $ref: "#/components/parameters/IdPath"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Categoria" }
        "404": { $ref: "#/components/responses/NotFound" }
    put:
      tags: [Tienda]
      summary: Reemplazar categoría
      operationId: categorias_reemplazar
      parameters:
        - $ref: "#/components/parameters/IdPath"
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/CategoriaUpdate" }
      responses:
        "200":
          description: Actualizado
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Categoria" }
        "404": { $ref: "#/components/responses/NotFound" }
    patch:
      tags: [Tienda]
      summary: Actualizar categoría (parcial)
      operationId: categorias_actualizar
      parameters:
        - $ref: "#/components/parameters/IdPath"
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/CategoriaUpdate" }
      responses:
        "200":
          description: Actualizado
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Categoria" }
        "404": { $ref: "#/components/responses/NotFound" }
    delete:
      tags: [Tienda]
      summary: Eliminar categoría
      operationId: categorias_eliminar
      parameters:
        - $ref: "#/components/parameters/IdPath"
      responses:
        "204": { description: Eliminado }
        "404": { $ref: "#/components/responses/NotFound" }

  /productos/:
    get:
      tags: [Tienda]
      summary: Listar productos
      operationId: productos_listar
      parameters:
        - $ref: "#/components/parameters/Page"
        - $ref: "#/components/parameters/PageSize"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/Producto" }
    post:
      tags: [Tienda]
      summary: Crear producto (JSON o multipart con imagen)
      operationId: productos_crear
      requestBody:
        $ref: "#/components/requestBodies/ProductoUpsert"
      responses:
        "201":
          description: Creado
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Producto" }
        "400": { $ref: "#/components/responses/BadRequest" }

  "/productos/{id}/":
    get:
      tags: [Tienda]
      summary: Obtener producto
      operationId: productos_obtener
      parameters:
        - $ref: "#/components/parameters/IdPath"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Producto" }
        "404": { $ref: "#/components/responses/NotFound" }
    put:
      tags: [Tienda]
      summary: Reemplazar producto (JSON o multipart con imagen)
      operationId: productos_reemplazar
      parameters:
        - $ref: "#/components/parameters/IdPath"
      requestBody:
        $ref: "#/components/requestBodies/ProductoUpsert"
      responses:
        "200":
          description: Actualizado
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Producto" }
        "400": { $ref: "#/components/responses/BadRequest" }
        "404": { $ref: "#/components/responses/NotFound" }
    patch:
      tags: [Tienda]
      summary: Actualizar producto (parcial)
      operationId: productos_actualizar
      parameters:
        - $ref: "#/components/parameters/IdPath"
      requestBody:
        $ref: "#/components/requestBodies/ProductoUpsert"
      responses:
        "200":
          description: Actualizado
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Producto" }
        "400": { $ref: "#/components/responses/BadRequest" }
        "404": { $ref: "#/components/responses/NotFound" }
    delete:
      tags: [Tienda]
      summary: Eliminar producto
      operationId: productos_eliminar
      parameters:
        - $ref: "#/components/parameters/IdPath"
      responses:
        "204": { description: Eliminado }
        "404": { $ref: "#/components/responses/NotFound" }

  "/productos/low-stock/":
    get:
      tags: [Tienda]
      summary: Productos con stock bajo (solo Administrador)
      operationId: productos_low_stock
      security:
        - bearerToken: []
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/Producto" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "403": { $ref: "#/components/responses/Forbidden" }

  /descuentos/:
    get:
      tags: [Tienda]
      summary: Listar descuentos
      operationId: descuentos_listar
      parameters:
        - $ref: "#/components/parameters/ActivosParam"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/ProductoDescuento" }
    post:
      tags: [Tienda]
      summary: Crear descuento (uno o varios productos)
      description: |
        - Si envías **producto_id** crea uno.
        - Si envías **productos** (array de IDs), intenta crear múltiples y puede devolver **207 Multi-Status**.
      operationId: descuentos_crear
      security:
        - bearerToken: []
      requestBody:
        $ref: "#/components/requestBodies/DescuentoCreate"
      responses:
        "201":
          description: Creado
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ProductoDescuento" }
        "207":
          description: Creado parcialmente (errores por producto)
        "400": { $ref: "#/components/responses/BadRequest" }
        "401": { $ref: "#/components/responses/Unauthorized" }

  "/descuentos/{id}/":
    get:
      tags: [Tienda]
      summary: Obtener descuento
      operationId: descuentos_obtener
      parameters:
        - $ref: "#/components/parameters/IdPath"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ProductoDescuento" }
        "404": { $ref: "#/components/responses/NotFound" }
    put:
      tags: [Tienda]
      summary: Reemplazar descuento
      operationId: descuentos_reemplazar
      security:
        - bearerToken: []
      parameters:
        - $ref: "#/components/parameters/IdPath"
      requestBody:
        $ref: "#/components/requestBodies/DescuentoUpdate"
      responses:
        "200":
          description: Actualizado
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ProductoDescuento" }
        "400": { $ref: "#/components/responses/BadRequest" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "404": { $ref: "#/components/responses/NotFound" }
    patch:
      tags: [Tienda]
      summary: Actualizar descuento (parcial)
      operationId: descuentos_actualizar
      security:
        - bearerToken: []
      parameters:
        - $ref: "#/components/parameters/IdPath"
      requestBody:
        $ref: "#/components/requestBodies/DescuentoUpdate"
      responses:
        "200":
          description: Actualizado
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ProductoDescuento" }
        "400": { $ref: "#/components/responses/BadRequest" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "404": { $ref: "#/components/responses/NotFound" }
    delete:
      tags: [Tienda]
      summary: Eliminar descuento
      operationId: descuentos_eliminar
      security:
        - bearerToken: []
      parameters:
        - $ref: "#/components/parameters/IdPath"
      responses:
        "204": { description: Eliminado }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "404": { $ref: "#/components/responses/NotFound" }

  "/descuentos/activos/":
    get:
      tags: [Tienda]
      summary: Listar descuentos activos (público)
      operationId: descuentos_activos_listar
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/ProductoDescuento" }

  /carritos/:
    get:
      tags: [Tienda]
      summary: Listar mis carritos (usuario autenticado)
      operationId: carritos_listar
      security:
        - bearerToken: []
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/Carrito" }
        "401": { $ref: "#/components/responses/Unauthorized" }
    post:
      tags: [Tienda]
      summary: Crear carrito vacío para el usuario
      operationId: carritos_crear
      security:
        - bearerToken: []
      responses:
        "201":
          description: Creado
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Carrito" }
        "401": { $ref: "#/components/responses/Unauthorized" }

  "/carritos/{id}/":
    get:
      tags: [Tienda]
      summary: Obtener carrito por ID (del usuario)
      operationId: carritos_obtener
      security:
        - bearerToken: []
      parameters:
        - $ref: "#/components/parameters/IdPath"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Carrito" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "404": { $ref: "#/components/responses/NotFound" }
    delete:
      tags: [Tienda]
      summary: Eliminar carrito
      operationId: carritos_eliminar
      security:
        - bearerToken: []
      parameters:
        - $ref: "#/components/parameters/IdPath"
      responses:
        "204": { description: Eliminado }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "404": { $ref: "#/components/responses/NotFound" }

  "/carritos/actual/":
    get:
      tags: [Tienda]
      summary: Obtener mi carrito actual (pendiente, autocreado si expiró)
      operationId: carritos_actual_get
      security:
        - bearerToken: []
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Carrito" }
        "401": { $ref: "#/components/responses/Unauthorized" }
    post:
      tags: [Tienda]
      summary: Reemplazar items del carrito actual
      description: |
        Envía un array `items` con `{ product_id, quantity }` para regenerar el carrito.
        Calcula precios con descuento activo cuando corresponda.
      operationId: carritos_actual_set
      security:
        - bearerToken: []
      requestBody:
        $ref: "#/components/requestBodies/CarritoActualSet"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Carrito" }
        "401": { $ref: "#/components/responses/Unauthorized" }

  /carrito-detalle/:
    get:
      tags: [Tienda]
      summary: Listar detalles (del usuario)
      operationId: carrito_detalle_listar
      security:
        - bearerToken: []
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/CarritoDetalle" }
        "401": { $ref: "#/components/responses/Unauthorized" }
    post:
      tags: [Tienda]
      summary: Crear detalle
      operationId: carrito_detalle_crear
      security:
        - bearerToken: []
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/CarritoDetalleCreate" }
      responses:
        "201":
          description: Creado
          content:
            application/json:
              schema: { $ref: "#/components/schemas/CarritoDetalle" }
        "401": { $ref: "#/components/responses/Unauthorized" }

  "/carrito-detalle/{id}/":
    get:
      tags: [Tienda]
      summary: Obtener detalle
      operationId: carrito_detalle_obtener
      security:
        - bearerToken: []
      parameters:
        - $ref: "#/components/parameters/IdPath"
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema: { $ref: "#/components/schemas/CarritoDetalle" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "404": { $ref: "#/components/responses/NotFound" }
    put:
      tags: [Tienda]
      summary: Reemplazar detalle
      operationId: carrito_detalle_reemplazar
      security:
        - bearerToken: []
      parameters:
        - $ref: "#/components/parameters/IdPath"
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/CarritoDetalleUpdate" }
      responses:
        "200":
          description: Actualizado
          content:
            application/json:
              schema: { $ref: "#/components/schemas/CarritoDetalle" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "404": { $ref: "#/components/responses/NotFound" }
    patch:
      tags: [Tienda]
      summary: Actualizar detalle (parcial)
      operationId: carrito_detalle_actualizar
      security:
        - bearerToken: []
      parameters:
        - $ref: "#/components/parameters/IdPath"
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/CarritoDetalleUpdate" }
      responses:
        "200":
          description: Actualizado
          content:
            application/json:
              schema: { $ref: "#/components/schemas/CarritoDetalle" }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "404": { $ref: "#/components/responses/NotFound" }
    delete:
      tags: [Tienda]
      summary: Eliminar detalle
      operationId: carrito_detalle_eliminar
      security:
        - bearerToken: []
      parameters:
        - $ref: "#/components/parameters/IdPath"
      responses:
        "204": { description: Eliminado }
        "401": { $ref: "#/components/responses/Unauthorized" }
        "404": { $ref: "#/components/responses/NotFound" }

components:
  securitySchemes:
    bearerToken:
      type: http
      scheme: bearer
      bearerFormat: opaque

  parameters:
    IdPath:
      name: id
      in: path
      required: true
      schema: { type: integer, minimum: 1 }
      description: ID interno
    Page:
      name: page
      in: query
      schema: { type: integer, minimum: 1, default: 1 }
      description: Página
    PageSize:
      name: page_size
      in: query
      schema: { type: integer, minimum: 1, maximum: 200, default: 20 }
      description: Tamaño de página
    ActivosParam:
      name: activos
      in: query
      schema: { type: boolean, default: false }
      description: Si es true, solo descuentos activos

  responses:
    Unauthorized:
      description: No autorizado
      content:
        application/json:
          schema:
            type: object
            properties:
              detail: { type: string, example: "No autenticado." }
    Forbidden:
      description: Prohibido (se requiere rol Administrador)
      content:
        application/json:
          schema:
            type: object
            properties:
              detail: { type: string, example: "No tiene permisos para realizar esta acción." }
    NotFound:
      description: Recurso no encontrado
      content:
        application/json:
          schema:
            type: object
            properties:
              detail: { type: string, example: "No encontrado." }
    BadRequest:
      description: Petición inválida
      content:
        application/json:
          schema:
            type: object
            properties:
              detail: { type: string, example: "Parámetros inválidos." }

  requestBodies:
    LoginRequest:
      required: true
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/LoginInput"
          examples:
            valido:
              value:
                username: "rsuarez"
                password: "MiClave#2025"
    ProductoUpsert:
      required: true
      content:
        application/json:
          schema: { $ref: "#/components/schemas/ProductoUpsert" }
        multipart/form-data:
          schema:
            type: object
            properties:
              payload:
                $ref: "#/components/schemas/ProductoUpsert"
              imagen:
                type: string
                format: binary
    CarritoActualSet:
      required: true
      content:
        application/json:
          schema:
            type: object
            required: [items]
            properties:
              items:
                type: array
                items:
                  type: object
                  required: [product_id, quantity]
                  properties:
                    product_id: { type: integer, minimum: 1 }
                    quantity:   { type: integer, minimum: 1 }
    DescuentoCreate:
      required: true
      content:
        application/json:
          schema:
            type: object
            properties:
              producto_id: { type: integer, minimum: 1 }
              productos:
                type: array
                items: { type: integer, minimum: 1 }
              porcentaje: { type: number, minimum: 0, maximum: 100 }
              vigente_desde: { type: string, format: date-time }
              vigente_hasta: { type: string, format: date-time }
    DescuentoUpdate:
      required: true
      content:
        application/json:
          schema:
            type: object
            properties:
              porcentaje: { type: number, minimum: 0, maximum: 100 }
              vigente_desde: { type: string, format: date-time }
              vigente_hasta: { type: string, format: date-time }

  schemas:
    # ===== Auth / Usuario =====
    LoginInput:
      type: object
      required: [username, password]
      properties:
        username: { type: string, example: "rsuarez" }
        password: { type: string, format: password, example: "MiClave#2025" }

    UsuarioPublico:
      type: object
      required: [id, username, email]
      properties:
        id: { type: integer, example: 42 }
        username: { type: string, example: "rsuarez" }
        email: { type: string, format: email, example: "rsuarez@mail.com" }
        rol:
          { type: integer, nullable: true, example: 1, description: "ID del rol o null" }
        rol_nombre: { type: string, nullable: true, readOnly: true, example: "Cliente" }
        permisos:
          type: array
          readOnly: true
          items: { type: string, example: "usuarios.ver" }

    UsuarioCreate:
      type: object
      required: [username, email, password]
      properties:
        username: { type: string, example: "mrcholo" }
        email: { type: string, format: email, example: "cholo@mail.com" }
        password: { type: string, format: password, example: "MiClave#2025" }
        rol:
          { type: integer, nullable: true, example: 1, description: "Si se omite, se usa rol 'Cliente' por defecto" }

    UsuarioUpdate:
      type: object
      properties:
        username: { type: string, example: "mrcholo" }
        email: { type: string, format: email, example: "cholo@mail.com" }
        password: { type: string, format: password, example: "OtraClave#2025" }
        rol: { type: integer, nullable: true, example: 2 }

    TokenResponse:
      type: object
      required: [token, user]
      properties:
        token:
          type: string
          description: Token Bearer opaco (firmado; no JWT)
          example: "eyJzaWduZWQiOiJhYmMxMjM0In0="
        user:
          $ref: "#/components/schemas/UsuarioPublico"

    # ===== Rol =====
    Rol:
      type: object
      required: [id, nombre]
      properties:
        id: { type: integer, example: 1 }
        nombre: { type: string, example: "Admin" }

    RolCreate:
      type: object
      required: [nombre]
      properties:
        nombre: { type: string, example: "Cliente" }

    RolUpdate:
      type: object
      properties:
        nombre: { type: string, example: "Operador" }

    # ===== Permiso =====
    Permiso:
      type: object
      required: [id, nombre]
      properties:
        id: { type: integer, example: 10 }
        nombre: { type: string, example: "usuarios.ver" }

    PermisoCreate:
      type: object
      required: [nombre]
      properties:
        nombre: { type: string, example: "usuarios.editar" }

    PermisoUpdate:
      type: object
      properties:
        nombre: { type: string, example: "usuarios.crear" }

    # ===== RolPermiso =====
    RolPermiso:
      type: object
      required: [id, rol, permiso]
      properties:
        id: { type: integer, example: 3 }
        rol: { type: integer, example: 1, description: "ID de Rol" }
        permiso: { type: integer, example: 10, description: "ID de Permiso" }
        rol_nombre: { type: string, readOnly: true, example: "Admin" }
        permiso_nombre: { type: string, readOnly: true, example: "usuarios.ver" }

    RolPermisoCreate:
      type: object
      required: [rol, permiso]
      properties:
        rol: { type: integer, example: 1 }
        permiso: { type: integer, example: 10 }

    RolPermisoUpdate:
      type: object
      properties:
        rol: { type: integer, example: 2 }
        permiso: { type: integer, example: 11 }

    # ===== Bitácora =====
    BitacoraEntry:
      type: object
      description: Entrada de bitácora (solo lectura)
      required: [id, accion, creado_en]
      properties:
        id: { type: integer, example: 1203 }
        usuario:
          type: integer
          nullable: true
          description: ID del usuario (si existía en el momento del evento)
          example: 42
        usuario_username:
          type: string
          nullable: true
          readOnly: true
          example: "rsuarez"
        accion:
          type: string
          example: "LOGIN"
        ip_address:
          type: string
          nullable: true
          example: "200.87.1.25"
          description: IP del cliente (X-Forwarded-For o REMOTE_ADDR)
        creado_en:
          type: string
          format: date-time
          example: "2025-11-05T21:14:17Z"

    PaginatedBitacora:
      type: object
      description: Respuesta paginada estilo DRF PageNumberPagination
      properties:
        count: { type: integer, example: 248 }
        next:
          type: string
          nullable: true
          format: uri
          example: "https://api.tuapp.com/api/bitacora/?page=3"
        previous:
          type: string
          nullable: true
          format: uri
          example: null
        results:
          type: array
          items:
            $ref: "#/components/schemas/BitacoraEntry"

    # ===== Tienda =====
    Categoria:
      type: object
      required: [id, nombre]
      properties:
        id: { type: integer, example: 1 }
        nombre: { type: string, example: "Refrigeradores" }
        descripcion: { type: string, nullable: true }
    CategoriaCreate:
      type: object
      required: [nombre]
      properties:
        nombre: { type: string }
        descripcion: { type: string, nullable: true }
    CategoriaUpdate:
      type: object
      properties:
        nombre: { type: string }
        descripcion: { type: string, nullable: true }

    Producto:
      type: object
      required: [id, nombre, precio, stock, categoria_id]
      properties:
        id: { type: integer, example: 101 }
        nombre: { type: string, example: "Refrigerador Inverter 300L" }
        descripcion: { type: string, nullable: true }
        precio: { type: number, example: 1299.99 }
        stock: { type: integer, example: 42 }
        imagen: { type: string, nullable: true, format: uri }
        categoria_id: { type: integer, example: 1 }
        low_stock_threshold: { type: integer, example: 5 }
    ProductoUpsert:
      type: object
      properties:
        nombre: { type: string }
        descripcion: { type: string, nullable: true }
        precio: { type: number }
        stock: { type: integer }
        categoria_id: { type: integer }
        low_stock_threshold: { type: integer }
        imagen: { type: string, nullable: true, description: "URL opcional si no se sube archivo" }

    ProductoDescuento:
      type: object
      required: [id, producto_id, porcentaje]
      properties:
        id: { type: integer, example: 7 }
        producto_id: { type: integer, example: 101 }
        porcentaje: { type: number, example: 15 }
        vigente_desde: { type: string, format: date-time }
        vigente_hasta: { type: string, format: date-time }
        activo: { type: boolean, example: true }

    Carrito:
      type: object
      required: [id, usuario_id, estado, total]
      properties:
        id: { type: integer, example: 3001 }
        usuario_id: { type: integer, example: 42 }
        estado: { type: string, example: "PENDIENTE" }
        total: { type: number, example: 259.98 }
        creado_en: { type: string, format: date-time }
        actualizado_en: { type: string, format: date-time }
        items:
          type: array
          items: { $ref: "#/components/schemas/CarritoDetalle" }

    CarritoDetalle:
      type: object
      required: [id, carrito_id, producto_id, cantidad, precio_unitario]
      properties:
        id: { type: integer, example: 9001 }
        carrito_id: { type: integer, example: 3001 }
        producto_id: { type: integer, example: 101 }
        cantidad: { type: integer, example: 2 }
        precio_unitario: { type: number, example: 129.99 }
        subtotal: { type: number, example: 259.98, readOnly: true }

    CarritoDetalleCreate:
      type: object
      required: [producto_id, cantidad]
      properties:
        producto_id: { type: integer, minimum: 1 }
        cantidad: { type: integer, minimum: 1 }

    CarritoDetalleUpdate:
      type: object
      properties:
        cantidad: { type: integer, minimum: 1 }
